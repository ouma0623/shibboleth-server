# /plan
# PDCA: Plan Phase
# Role: PM / PL / Architect

## 【このコマンドの位置づけ】
Planフェーズは「唯一の意思決定フェーズ」である。
ここで決めた内容は、Do / Check では変更してはならない。

本フェーズの成果物は以下である：
- docs による仕様の確定
- 親Plan Issue の作成
- 子Task Issue の“全量確定”
- docs / Issue の同期基盤構築

---

## 【ルール理解チェック（必須・省略不可）】
各コマンド実行時、最初に以下を短く宣言してから作業を進める。

- 私は以下を理解し遵守する：
  1) Planは唯一の意思決定フェーズであり、ここで決めた内容はDo/Checkでは変更しない
  2) 不明点・懸念がある場合は必ず質問し、推測で進めない
  3) 要件定義を充実化し、各機能要件に「入力・出力・例外・受け入れ条件」を必ず記載する
  4) 全Task IssueをPlanフェーズで全量確定し、Do/Checkで追加しない
  5) docs更新時は必ずdocs/00_INDEX.mdも更新し、整合性を確認する

※ これを省略しない

## 【前提理解チェック（必須・省略不可）】
以下を理解し、遵守すること。

- docs は仕様の唯一の正（Single Source of Truth）
- タスクは Plan フェーズでのみ作成する
- Do / Check で仕様・タスクは増やさない
- MCP を用いて GitHub / docs を直接操作する
- ObsidianへのコピーはActionフェーズで自動実行する
- 実行結果は ID / URL / 差分で報告する
- **/review からの遷移時**：レビュー結果を要件定義の材料として使用し、改善候補をTask化する
- **AIナレッジ参照**：Obsidian側のAIナレッジディレクトリ（`/mnt/d/work/obsidian/cursor/20_KNOWLEDGE/`）を必ず参照して実施する

---

## 【質問プロセス（必須・省略不可）】
> **重要**：Planフェーズは「唯一の意思決定フェーズ」である。  
> **少しでも不明な点や懸念がある場合は、必ずユーザーに質問すること。推測で進めてはならない。**

### 質問すべき状況
以下のいずれかに該当する場合は、**必ず質問**すること：

- [ ] 要件・仕様が不明確・曖昧である
- [ ] 複数の解釈が可能な記述がある
- [ ] 技術的な選択肢が複数あり、どれを選ぶべきか判断できない
- [ ] 既存コード・設計との整合性に疑問がある
- [ ] 制約・前提条件が不明確である
- [ ] 受け入れ基準が具体的でない
- [ ] 実装方法に迷いがある
- [ ] リスク・懸念事項を発見した
- [ ] データ形式・API仕様が不明確である
- [ ] 非機能要件（性能・セキュリティ・運用）が未定義である

### 質問の原則
1. **推測で進めない**：不明点を推測で埋めず、必ず質問する
2. **早期に質問する**：後で問題になる前に、Planフェーズで明確にする
3. **具体的に質問する**：曖昧な質問ではなく、選択肢や具体例を示す
4. **複数の観点から質問する**：実装・テスト・運用・セキュリティなど多角的に確認する
5. **質問をためらわない**：小さな疑問でも、Doフェーズで迷う原因になるなら質問する

### 質問の形式例
質問する際は、以下の形式で明確に示すこと：

```
【質問】<質問のカテゴリ>
- 不明点・懸念：
- 現在の理解：
- 選択肢・候補：
- 推奨される判断基準：
- 質問内容：
```

**例：**
```
【質問】技術選択
- 不明点・懸念：データベース接続ライブラリの選択
- 現在の理解：既存コードではSQLAlchemyを使用している
- 選択肢・候補：
  1) 既存のSQLAlchemyを継続使用
  2) 新しいライブラリ（例：asyncpg）に変更
- 推奨される判断基準：パフォーマンス要件、既存コードとの整合性
- 質問内容：新機能でもSQLAlchemyを使用すべきか、それとも別のライブラリを検討すべきか？
```

### 質問すべき観点
以下の観点から、不明点がないか**必ず確認**すること：

**要件・仕様の明確性**
- 「この要件は何を意味するのか？具体的な動作は？」
- 「この要件を実装する際、どのような技術・方法を使うべきか？」
- 「この要件の受け入れ基準は具体的に何か？」

**技術的な選択**
- 「既存コードとの整合性は取れているか？」
- 「使用すべき技術・ライブラリ・APIは何か？」
- 「パフォーマンス・セキュリティ要件を満たす実装方法は？」

**データ・API仕様**
- 「入力データの形式・制約は何か？」
- 「出力データの形式・エラーハンドリングはどうすべきか？」
- 「API仕様・インターフェースは定義されているか？」

**非機能要件**
- 「性能要件（レスポンス時間・スループット）は具体的に何か？」
- 「セキュリティ要件（認証・認可・機密情報）は明確か？」
- 「運用要件（監視・アラート・ロールバック）は定義されているか？」

**リスク・制約**
- 「実装上のリスク・懸念事項はないか？」
- 「技術的制約・外部依存は全て把握できているか？」
- 「期限・コスト制約は明確か？」

### 質問後の対応
- ユーザーからの回答を受けたら、**必ず要件定義に反映**する
- 回答内容を`requirements.md`に明文化する（設計書が存在する場合は、docs/00_INDEX.mdを参照して適切なファイルに記載）
- 質問と回答の記録を残し、将来の参照に備える

---

## 【責務】
- **要件定義を徹底的に充実化し、エージェントが完全に理解して開発できる状態にする**
- **不明点・懸念を発見したら、必ずユーザーに質問し、明確化する**
- 要件・設計・スコープを確定する
- 実装単位までタスクを分解する
- 実務上のリスク・制約を明文化する
- **Doフェーズで迷う要素をPlanフェーズで全て潰す**

---

## 【禁止事項】
- 実装・テストを始めること
- Task を曖昧な粒度で作成すること
- docs を更新せずに Issue を作成すること
- **要件定義に曖昧な表現・未確定事項を残すこと**
- **「〜する必要がある」「適切に」などの主観的・曖昧な表現を使用すること**
- **機能要件に「入力・出力・例外・受け入れ条件」のいずれかを省略すること**
- **非機能要件（性能・可用性・セキュリティ・運用）を省略すること**
- **不明点・懸念があるのに質問せず、推測で進めること**
- **「多分こうだろう」と推測して要件定義を埋めること**
- **小さな疑問を「後で確認すればいい」と先送りすること**

---

## 【Operation Plan（MCP実行仕様）】

### 1. docs 読み取り（Read）
- docs/00_INDEX.md を最初に確認し、プロジェクトのdocs構成を把握する
- docs/01_REQUIREMENTS/requirements.md
  - **既存要件の不足・曖昧さを特定する観点で読み込む**
  - 各機能要件に「入力・出力・例外・受け入れ条件」が全て記載されているか確認
  - 非機能要件が全て定義されているか確認
  - **不明点・曖昧な記述を発見したら、必ず質問する（推測で進めない）**
- docs/00_INDEX.md に記載されている設計書（存在する場合）
  - 既存設計との整合性を確認
  - 設計で不明確な点を要件定義に反映する
  - **設計の意図が不明確な場合は質問する**
- 既存コード（影響範囲把握）
  - 実装パターン・技術スタックを理解し、要件定義の技術的制約に反映
  - **既存コードの意図が不明確な場合は質問する**
- **/review からの遷移時のみ**：/review で作成されたレビュー結果サマリを読み込む
  - レビュー結果の改善候補を要件定義の入力として使用する
  - 即時対応が必要な致命的リスクがあれば、優先度を上げてTask化する
  - **レビュー結果の解釈に迷いがある場合は質問する**

### 2. 要件定義充実化（必須・省略不可）
> **重要**：エージェントが完全に理解して開発できるよう、要件定義を徹底的に充実させる。
> 曖昧さを残さず、Doフェーズで迷う要素をPlanフェーズで全て潰す。

#### 2.1 要件定義の品質チェック（各セクションで必須）
requirements.md を更新する際、以下の観点で**必ず確認・記入**すること：

**背景・目的セクション（1-2章）**
- [ ] 「なぜ今やるのか」が明確か？（機会・リスク・緊急度）
- [ ] 「誰が困っているのか」が明確か？（ステークホルダー・影響範囲）
- [ ] 「達成したい状態」が具体的か？（抽象的な表現を排除）
- [ ] 「成果の使われ方」が明確か？（誰が/いつ/何のために使うか）

**スコープセクション（3章）**
- [ ] In Scope が具体的か？（「機能Xを実装する」ではなく「機能XのY機能をZ条件で実装する」）
- [ ] Out of Scope が明確か？（「やらないこと」を明示し、将来の拡張性も考慮）
- [ ] 対象環境・リポジトリ・ディレクトリが特定されているか？

**ユースケースセクション（4章）**
- [ ] 各ユースケースに「利用者」「操作/入力」「期待結果」が全て記載されているか？
- [ ] 異常系・エッジケースも考慮されているか？
- [ ] ユースケースが要件と1対1で対応しているか？

**機能要件セクション（5.1章）**
各機能要件（FR-XX）について以下を**必ず記入**：
- [ ] **説明**：何をする機能か（曖昧な表現を排除）
- [ ] **入力**：具体的な入力データ・パラメータ・形式・制約
- [ ] **出力**：具体的な出力データ・形式・エラーメッセージ
- [ ] **例外/異常系**：想定されるエラー・例外処理・リトライ方針
- [ ] **受け入れ条件（Acceptance）**：Checkフェーズで判定可能な具体的な条件

**非機能要件セクション（5.2章）**
以下を**必ず記入**（分からなければ仮置きして明示）：
- [ ] **性能**：具体的な数値目標（レスポンス時間・スループット・バッチ時間）
- [ ] **可用性**：目標稼働率・障害時の許容範囲・復旧時間
- [ ] **セキュリティ**：認証/認可方式・機密情報の取り扱い・ログ方針
- [ ] **運用**：監視項目・アラート条件・ロールバック手順
  - [ ] **監査/証跡**：Issue/Obsidianに残すべき証跡の種類

**データ要件セクション（6章）**
- [ ] データソースが特定されているか？（ファイル・DB・API等）
- [ ] データ形式・スキーマが明確か？
- [ ] データ品質要件（欠損・重複・フォーマット検証）が定義されているか？

**制約セクション（7章）**
- [ ] 技術的制約（使用技術・ライブラリ・バージョン）が明確か？
- [ ] 期限・コスト制約が明示されているか？
- [ ] 外部依存（API・権限・第三者サービス）が全て列挙されているか？

**受け入れ基準セクション（8章）**
- [ ] 各受け入れ基準（AC-XX）が**測定可能・検証可能**か？
- [ ] 「動いた気がする」を排除し、具体的な検証方法が記載されているか？
- [ ] 正常系・異常系・境界値の全てがカバーされているか？

#### 2.2 エージェントが自問自答すべき質問リスト
要件定義を記入する際、以下の質問に**必ず回答**すること。  
**回答できない場合は、必ずユーザーに質問すること（推測で進めない）。**

**実装観点**
- 「この要件を実装するために、どのような技術・ライブラリ・APIが必要か？」
  - **不明な場合は質問する**
- 「既存コードとの整合性は取れているか？影響範囲は？」
  - **不明な場合は質問する**
- 「この要件を実装する際、Doフェーズで迷う可能性のある点はないか？」
  - **迷う可能性がある場合は質問する**

**テスト観点**
- 「この要件をテストするために、どのような入力・出力・検証が必要か？」
  - **不明な場合は質問する**
- 「異常系・エッジケースは全て考慮されているか？」
  - **考慮漏れの可能性がある場合は質問する**
- 「受け入れ基準が具体的で検証可能か？」
  - **検証方法が不明な場合は質問する**

**運用観点**
- 「この機能を運用するために、どのような監視・アラートが必要か？」
  - **不明な場合は質問する**
- 「障害時の復旧手順は明確か？」
  - **不明な場合は質問する**
- 「ロールバックが必要な場合、手順は定義されているか？」
  - **不明な場合は質問する**

**データ観点**
- 「入力データの形式・制約・バリデーション要件は明確か？」
  - **不明な場合は質問する**
- 「出力データの形式・エラーメッセージは定義されているか？」
  - **不明な場合は質問する**
- 「データの永続化・削除・バックアップ要件は？」
  - **不明な場合は質問する**

**セキュリティ観点**
- 「認証・認可の要件は明確か？」
  - **不明な場合は質問する**
- 「機密情報の取り扱い・ログ出力方針は？」
  - **不明な場合は質問する**
- 「セキュリティリスクは考慮されているか？」
  - **懸念がある場合は質問する**

#### 2.3 曖昧さ排除チェックリスト
要件定義を完了したら、以下を**必ず確認**：

- [ ] 「〜する必要がある」「〜すべき」などの曖昧な表現を排除し、具体的な動作に置き換えたか？
- [ ] 「適切に」「適度に」などの主観的な表現を排除し、数値・条件で定義したか？
- [ ] 「〜など」などの省略表現を排除し、全て列挙したか？
- [ ] 「将来的に」「必要に応じて」などの未確定表現を排除し、現時点での決定事項のみを記載したか？
- [ ] Doフェーズで「これはどう実装すればいいのか？」と迷う可能性のある記述がないか？

#### 2.4 要件定義の完成度確認
requirements.md の更新が完了したら、以下を**必ず確認**：

- [ ] 全てのセクションが埋まっているか？（空欄・TODO・仮置きを残していないか）
  - **仮置きやTODOがある場合は、必ず質問して明確化する**
- [ ] 各機能要件（FR-XX）が独立して理解できるか？（他の要件を読まなくても実装可能か）
  - **理解できない場合は質問する**
- [ ] 受け入れ基準（AC-XX）が具体的で検証可能か？
  - **検証方法が不明な場合は質問する**
- [ ] Doフェーズで迷う要素が残っていないか？
  - **迷う可能性がある場合は質問する**
- [ ] Checkフェーズで「OK/NG」を判定できる基準が全て定義されているか？
  - **判定基準が不明確な場合は質問する**
- [ ] **不明点・懸念事項を全て質問し、回答を得ているか？**
  - **質問せずに推測で埋めた箇所がないか確認する**

### 3. docs 更新（Update）
- requirements.md（上記2.1-2.4のガイドラインに従って充実化）
- design docs（設計方針・構成）※必要に応じて
- docs/00_INDEX.md（Issue 参照枠作成・docs更新の反映）

#### 3.1 docs/00_INDEX.md 更新チェック（必須）
docs更新後、必ず以下を確認し、必要に応じて docs/00_INDEX.md を更新する：

- [ ] 新規docs追加時：INDEX.mdに追加されているか
- [ ] docs削除時：INDEX.mdから削除されているか
- [ ] docs移動時：INDEX.mdのパスが正しいか
- [ ] リンク切れがないか確認
- [ ] Issue参照枠が正しく作成・更新されているか

### 4. GitHub Issue 作成（Create）
- 親Issue（Plan）
  - テンプレ: 00_plan_overview.md
  - 内容: 設計方針 / Done / Task一覧
- 子Issue（Task）
  - テンプレ: 10_task.md
  - 数: 必要十分な数を Plan で全て作成
  - 親Issue番号を必ず記載

### 5. 親Issue更新（Update）
- Task一覧表に子Issue番号を反映
- 状態はすべて「未着手」

### 6. Obsidian PJディレクトリ作成（該当時のみ）
> **注意**：案件固有の作業ファイルを配置するためのディレクトリを作成する。  
> 作業ファイルが発生する可能性がある場合のみ作成する。

1) PJ番号を決定する
   - 実行月（YYYY-MM形式）を取得する
   - 既存のPJ番号を確認する（`docs/90_OBSIDIAN/` 配下）
   - 同じ月（YYYY-MM）内での最大PJ番号を特定する
   - 新しいPJ番号を決定する（形式：`PJ<XXX>-<YYYY-MM>`）
     - 既存のPJ番号がない場合：`PJ001-<YYYY-MM>`
     - 既存のPJ番号がある場合：最大番号+1（例：`PJ001-2025-12` が存在する場合、次は `PJ002-2025-12`）
2) PJディレクトリを作成する
   - `docs/90_OBSIDIAN/PJ<XXX>-<YYYY-MM>/`
   - `docs/90_OBSIDIAN/PJ<XXX>-<YYYY-MM>/99_work_files/`
3) 作業ファイルが発生した場合の配置先を明確にする
   - Plan/Do/Checkフェーズで作成される作業ファイルは `99_work_files/` に配置する

### 7. 整合性検証（Verify）
- Plan Issue ↔ Task Issue 全リンク確認
- docs/00_INDEX ↔ Issue 確認
- docs更新とINDEX.mdの整合性確認（3.1のチェックリストに従って確認）
- Obsidian PJディレクトリが作成されている（作業ファイルが発生する場合）

---

## 【フェーズ完了条件】
- すべての Task が Issue 化されている
- 仕様・設計が docs に明文化されている
- **要件定義が充実化され、Do フェーズで迷う要素が残っていない**
  - requirements.md の全セクションが埋まっている
  - 各機能要件（FR-XX）に「入力・出力・例外・受け入れ条件」が全て記載されている
  - 非機能要件（性能・可用性・セキュリティ・運用）が全て定義されている
  - 受け入れ基準（AC-XX）が具体的で検証可能である
  - 曖昧な表現・未確定事項が排除されている
- **不明点・懸念事項を全て質問し、回答を得て要件定義に反映している**
  - 推測で埋めた箇所がない
  - 全ての質問に回答を得ている
  - 質問と回答の記録が残っている

---

## 【出力（実行後に必ず報告）】
- Plan Issue URL
- Task Issue 一覧（ID / URL）
- 更新した docs 一覧
- 次に着手すべき Task ID
- **質問と回答の記録**（不明点を質問した場合は、質問内容と回答を報告）

---

## 【フェーズ宣言】
Planフェーズを開始する。
Planフェーズを終了する。
