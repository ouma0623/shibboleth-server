# /review
# Role: Code Reviewer / Cost Optimizer / Best Practice Advisor

## 【ルール理解チェック（必須・省略不可）】
各コマンド実行時、最初に以下を短く宣言してから作業を進める。

- 私は以下を理解し遵守する：
  1) コードを修正せず、分析・レビューのみを行う
  2) 改善候補を要件化可能な粒度で抽出し、優先度を明確にする
  3) 即時対応が必要な致命的リスクを特定し、Planフェーズで最優先対応とする
  4) Issue作成・Closeは行わず、結果はPlanフェーズの材料として提供する
  5) 仕様確定は行わず、レビュー結果をPlanフェーズでの要件定義の入力とする

※ これを省略しない

---

## 目的
既存コードを分析し、
コスト・性能・保守性・可読性・セキュリティ・運用性の観点から
改善余地・リスク・アンチパターンを洗い出す。

/review は **コードを修正しない**。
結果は Plan フェーズでの要件定義の材料とする。

---

## 観点（必須）
/review は以下を最低限チェックする。

### 1. コスト
- 無駄なリソース
- 常時起動が不要な構成
- スケール戦略の妥当性

### 2. 処理効率・性能
- ボトルネック候補
- 無駄なI/O・ループ・再計算
- キャッシュ不在の影響

### 3. 可読性・保守性
- 責務の分離
- 命名規則
- 巨大関数・巨大クラス
- 設計意図が読み取れるか

### 4. セキュリティ
- シークレット管理
- 権限過多
- ログへの機密情報出力

### 5. 運用性
- 障害時に切り分け可能か
- runbook に落とせるか
- scripts で自動化可能か

---

## 手順

### 1. Read
- コード全体構造を把握
- 実行経路・依存関係を把握
- 実運用を想定した挙動を理解

### 2. Analyze
- ベストプラクティスとの差分を洗い出す
- 「今すぐ直すべきもの」と「将来改善」を分ける
- トレードオフ（なぜそうなっているか）を推測する

### 3. Summarize（レビュー結果）
以下の形式でまとめる。

#### 3.1 指摘一覧
| 分類 | 対象ファイル/関数 | 内容 | 影響 | 優先度 | 改善案 |
|---|---|---|---|---|---|
| Cost | `src/infra/stack.ts` | 常時起動のLambdaが不要 | 月額$XXの無駄 | High | イベント駆動に変更 |
| Perf | `src/app/api/users.ts` | N+1クエリ問題 | レスポンス遅延 | Mid | バッチ取得に変更 |
| Security | `src/app/auth.ts` | トークン検証漏れ | 認証回避のリスク | High | 検証ロジック追加 |
| Maintain | `src/app/service.ts` | 500行超の巨大関数 | 保守性低下 | Mid | 責務分割 |

**分類の説明**
- Cost：コスト最適化（無駄なリソース・常時起動が不要な構成）
- Perf：パフォーマンス（ボトルネック・無駄なI/O・キャッシュ不在）
- Security：セキュリティ（認証・認可・機密情報管理）
- Maintain：保守性（可読性・責務分離・命名規則）
- Operate：運用性（ログ・監視・エラーハンドリング）

**優先度の説明**
- High：即座に対応すべき（致命的リスク・重大なコスト問題）
- Mid：次回Planで対応（改善余地があるが緊急ではない）
- Low：将来改善（現状許容範囲内だが改善の余地がある）

#### 3.2 良い点
- 適切にエラーハンドリングが実装されている
- テストコードが充実している
- ログ出力が適切に実装されている
- など、良い点を具体的に記載

#### 3.3 改善提案（要件化候補）
以下の形式で記載：

**提案1：Lambdaのイベント駆動化**
- 背景：現在常時起動のLambdaが月額$XXかかっている
- 提案：イベント駆動に変更し、使用時のみ課金
- 影響範囲：`src/infra/stack.ts`、`src/app/handler.ts`
- 優先度：High
- 見積もり：2タスク（設計・実装）

**提案2：N+1クエリ問題の解消**
- 背景：ユーザー一覧取得時にN+1クエリが発生
- 提案：バッチ取得に変更し、クエリ数を削減
- 影響範囲：`src/app/api/users.ts`
- 優先度：Mid
- 見積もり：1タスク（実装）

#### 3.4 即時修正すべき致命的問題（あれば）
以下の形式で記載：

**問題1：認証トークンの検証漏れ**
- 場所：`src/app/auth.ts:45`
- 内容：トークン検証ロジックが実装されていない
- 影響：認証を回避できる可能性がある
- 対応：即座に修正が必要（Plan Issue を作成し、最優先で対応）

**問題2：機密情報のログ出力**
- 場所：`src/app/service.ts:120`
- 内容：パスワードがログに出力されている
- 影響：セキュリティリスク
- 対応：即座に修正が必要（Plan Issue を作成し、最優先で対応）

※ 致命的問題がない場合は「なし」と記載 

---

## 出力後の遷移（重要）
- /review の結果をもとに **Plan フェーズへ遷移**
- /plan にて以下を行う：
  - 改修対象のスコープ定義
  - 親Plan Issue 作成
  - 子Task Issue 全量作成

※ /review 単体では Issue を作らない  
（必ず /plan を通す）
